---
import Layout from '../../layouts/Layout.astro';

const title = "Reescritor de Texto con IA | Devcito Utils";
const description = "Una herramienta para reformular y mejorar textos usando inteligencia artificial con opciones de tono, longitud y formato.";
---

<Layout title={title} description={description}>
    <main class="flex-grow flex flex-col items-center p-4 sm:p-6 md:p-8">
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-white">Reescritor de Texto con IA</h1>
            <p class="text-lg text-gray-400 mt-2">Reformula y mejora tus textos con opciones personalizables.</p>
        </div>
    
        <div class="w-full">
            <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg w-full max-w-4xl mx-auto border border-gray-700/80">
                <div class="space-y-6">
                    <p class="text-sm text-yellow-300 bg-yellow-900/30 p-3 rounded-lg border border-yellow-700/50">✨ Esta herramienta utiliza la IA integrada de tu navegador (disponible en Chrome 127+ para PC). No se necesitan claves API y tus datos no salen de tu dispositivo.</p>
                    
                    <div id="error-container" class="hidden text-sm text-red-300 bg-red-900/30 p-3 rounded-lg border border-red-700/50">
                        <p id="error-message"></p>
                        <p class="mt-2 text-gray-400">
                            Para habilitarlo, copia y pega lo siguiente en tu barra de direcciones: <code class="text-yellow-300 select-all">chrome://flags/#optimization-guide-on-device-model</code>
                        </p>
                    </div>

                    <div id="download-progress" class="hidden">
                        <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                            <p class="text-sm text-gray-300 mb-2">Descargando modelo de IA...</p>
                            <div class="w-full bg-gray-600 rounded-full h-2.5">
                                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="progress-text" class="text-xs text-gray-400 mt-2">0%</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2">Idioma de Salida</label>
                            <select id="output-language" class="w-full p-3 bg-gray-900/70 text-white border-2 border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <option value="es">Español</option>
                                <option value="en">Inglés</option>
                                <option value="ja">Japonés</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2">Tono</label>
                            <select id="tone" class="w-full p-3 bg-gray-900/70 text-white border-2 border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <option value="as-is">Sin cambios</option>
                                <option value="more-formal">Más formal</option>
                                <option value="more-casual">Más casual</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2">Longitud</label>
                            <select id="length" class="w-full p-3 bg-gray-900/70 text-white border-2 border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <option value="as-is">Sin cambios</option>
                                <option value="shorter">Más corto</option>
                                <option value="longer">Más largo</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">Formato</label>
                        <select id="format" class="w-full p-3 bg-gray-900/70 text-white border-2 border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="as-is">Sin cambios</option>
                            <option value="plain-text">Texto plano</option>
                            <option value="markdown">Markdown</option>
                        </select>
                    </div>

                    <div>
                        <label for="ai-input" class="block text-sm font-bold text-gray-300 mb-2">Texto Original</label>
                        <textarea
                            id="ai-input"
                            rows="8"
                            class="w-full p-3 bg-gray-900/70 text-white border-2 border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            placeholder="Pega aquí el texto que quieres reescribir..."
                        ></textarea>
                    </div>
    
                    <div class="flex items-center justify-center">
                        <button id="rewrite-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-all duration-200 transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:transform-none">
                            Reescribir Texto
                        </button>
                    </div>
    
                    <div>
                        <label for="ai-output" class="block text-sm font-bold text-gray-300 mb-2">Texto Reescrito</label>
                        <textarea
                            id="ai-output"
                            rows="8"
                            class="w-full p-3 bg-gray-900/70 text-white border-2 border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-600"
                            readonly
                            placeholder="El texto reescrito aparecerá aquí en tiempo real..."
                        ></textarea>
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script is:inline>
    document.addEventListener('DOMContentLoaded', async () => {
        const textInput = document.getElementById('ai-input');
        const outputText = document.getElementById('ai-output');
        const rewriteBtn = document.getElementById('rewrite-btn');
        const languageSelect = document.getElementById('output-language');
        const toneSelect = document.getElementById('tone');
        const lengthSelect = document.getElementById('length');
        const formatSelect = document.getElementById('format');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const downloadProgress = document.getElementById('download-progress');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        let rewriterSession = null;

        if (typeof Rewriter === 'undefined') {
            errorContainer.classList.remove('hidden');
            errorMessage.textContent = "Error: La API de Rewriter no está disponible en tu navegador. Se requiere Chrome 127+ con las flags habilitadas.";
            rewriteBtn.disabled = true;
            textInput.disabled = true;
            languageSelect.disabled = true;
            toneSelect.disabled = true;
            lengthSelect.disabled = true;
            formatSelect.disabled = true;
            return;
        }

        rewriteBtn.addEventListener('click', async () => {
            const text = textInput.value.trim();
            if (!text) {
                outputText.value = "⚠️ Por favor, introduce el texto que quieres reescribir.";
                return;
            }

            rewriteBtn.disabled = true;
            outputText.value = "";
            let modeloDescargado = false;

            try {
                rewriteBtn.textContent = "Preparando...";
                
                rewriterSession = await Rewriter.create({
                    outputLanguage: languageSelect.value,
                    tone: toneSelect.value,
                    length: lengthSelect.value,
                    format: formatSelect.value,
                    monitor(m) {
                        m.addEventListener("downloadprogress", (e) => {
                            downloadProgress.classList.remove('hidden');
                            const porcentaje = ((e.loaded / e.total) * 100).toFixed(1);
                            progressBar.style.width = `${porcentaje}%`;
                            progressText.textContent = `${porcentaje}%`;
                            rewriteBtn.textContent = "Descargando modelo...";
                            
                            if (e.loaded === e.total) {
                                modeloDescargado = true;
                                setTimeout(() => {
                                    downloadProgress.classList.add('hidden');
                                }, 1000);
                            }
                        });
                    }
                });

                rewriteBtn.textContent = "Reescribiendo...";
                
                const stream = rewriterSession.rewriteStreaming(text);
                
                for await (const chunk of stream) {
                    outputText.value = outputText.value + chunk;
                }

                rewriteBtn.textContent = "✓ Completado";
                setTimeout(() => {
                    rewriteBtn.textContent = "Reescribir Texto";
                }, 2000);

            } catch (error) {
                console.error(error);
                outputText.value = "❌ Ocurrió un error al reescribir el texto. Revisa la consola para más detalles.";
                errorContainer.classList.remove('hidden');
                errorMessage.textContent = `Error: ${error.message}`;
            } finally {
                rewriteBtn.disabled = false;
            }
        });
    });
</script>